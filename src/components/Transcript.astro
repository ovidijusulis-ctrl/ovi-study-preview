---
import VocabPopup from "./VocabPopup.jsx";
import InlineQuestion from "./InlineQuestion.jsx";

const { transcript = "", paragraphQuestions = [] } = Astro.props;

const SECTION_MARKERS = [
  "OPENING",
  "VOCABULARY",
  "NEWS STORY",
  "REVIEW",
  "PRACTICE",
  "CLOSING",
];

function splitTranscriptSections(text) {
  const sections = [];
  const markerRegex = /\[(OPENING|VOCABULARY|NEWS STORY|REVIEW|PRACTICE|CLOSING)\]/g;
  let match;
  let lastIndex = 0;
  let currentName = null;

  while ((match = markerRegex.exec(text)) !== null) {
    if (currentName !== null) {
      sections.push({
        name: currentName,
        content: text.slice(lastIndex, match.index).trim(),
      });
    }
    currentName = match[1];
    lastIndex = markerRegex.lastIndex;
  }

  if (currentName !== null) {
    sections.push({
      name: currentName,
      content: text.slice(lastIndex).trim(),
    });
  }

  if (sections.length === 0 && text.trim()) {
    sections.push({ name: "TRANSCRIPT", content: text.trim() });
  }

  const order = new Map(SECTION_MARKERS.map((name, index) => [name, index]));
  return sections.sort((a, b) => {
    const aOrder = order.has(a.name) ? order.get(a.name) : 999;
    const bOrder = order.has(b.name) ? order.get(b.name) : 999;
    return aOrder - bOrder;
  });
}

// Build a lookup: paragraphIndex -> question data
const questionMap = new Map();
for (const q of paragraphQuestions) {
  questionMap.set(q.paragraphIndex, q);
}

const sections = splitTranscriptSections(transcript);
---

<section class="card transcript-root" data-transcript-root>
  <h2>Transcript</h2>
  <p class="transcript-hint">
    Tap any word you don't know to see its meaning.
  </p>

  {
    sections.map((section) => {
      const paragraphs = section.content
        .split(/\n{2,}/)
        .map((paragraph) => paragraph.trim())
        .filter(Boolean);

      const isNewsStory = section.name === "NEWS STORY";

      return (
        <div class="transcript-section">
          <h3 class="transcript-section-title">{section.name}</h3>
          {paragraphs.map((paragraph, pIdx) => (
            <>
              <p class="transcript-paragraph">
                {paragraph.split(/(\s+)/).map((token) => {
                  if (/^\s+$/.test(token)) return token;

                  const cleaned = token.replace(/[^a-zA-Z'-]/g, "");
                  if (cleaned.length < 2) return token;

                  return (
                    <button
                      type="button"
                      class="transcript-word"
                      data-word={cleaned}
                    >
                      {token}
                    </button>
                  );
                })}
              </p>
              {isNewsStory && questionMap.has(pIdx) && (
                <InlineQuestion
                  client:load
                  question={questionMap.get(pIdx).question}
                  answer={questionMap.get(pIdx).answer}
                  hint={questionMap.get(pIdx).hint}
                />
              )}
            </>
          ))}
        </div>
      );
    })
  }

  <VocabPopup client:load />
</section>

<script is:inline>
  const root = document.querySelector("[data-transcript-root]");
  if (root) {
    root.addEventListener("click", (event) => {
      const target = event.target.closest("[data-word]");
      if (!target) return;

      const word = target.dataset.word;
      if (!word || word.length < 2) return;

      // Extract sentence context from parent paragraph
      const paragraph = target.closest(".transcript-paragraph");
      let sentence = "";
      if (paragraph) {
        const paraText = paragraph.textContent || "";
        const sentences = paraText.match(/[^.!?]+[.!?]+/g) || [paraText];
        const wordLower = word.toLowerCase();
        sentence = (
          sentences.find((s) => s.toLowerCase().includes(wordLower)) || paraText
        ).trim();
      }

      window.dispatchEvent(
        new CustomEvent("open-vocab-popup", {
          detail: {
            word: word,
            sentence: sentence,
          },
        }),
      );
    });
  }
</script>
