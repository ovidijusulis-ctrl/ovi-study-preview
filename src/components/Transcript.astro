---
import VocabPopup from "./VocabPopup.jsx";

const { transcript = "", vocabulary = [] } = Astro.props;

const SECTION_MARKERS = [
  "OPENING",
  "VOCABULARY",
  "NEWS STORY",
  "REVIEW",
  "PRACTICE",
  "CLOSING",
];

function normalizeWord(value) {
  return String(value).toLowerCase().replace(/[^a-z']/g, "");
}

function splitTranscriptSections(text) {
  const sections = [];
  const markerRegex = /\[(OPENING|VOCABULARY|NEWS STORY|REVIEW|PRACTICE|CLOSING)\]/g;
  let match;
  let lastIndex = 0;
  let currentName = null;

  while ((match = markerRegex.exec(text)) !== null) {
    if (currentName !== null) {
      sections.push({
        name: currentName,
        content: text.slice(lastIndex, match.index).trim(),
      });
    }
    currentName = match[1];
    lastIndex = markerRegex.lastIndex;
  }

  if (currentName !== null) {
    sections.push({
      name: currentName,
      content: text.slice(lastIndex).trim(),
    });
  }

  if (sections.length === 0 && text.trim()) {
    sections.push({ name: "TRANSCRIPT", content: text.trim() });
  }

  const order = new Map(SECTION_MARKERS.map((name, index) => [name, index]));
  return sections.sort((a, b) => {
    const aOrder = order.has(a.name) ? order.get(a.name) : 999;
    const bOrder = order.has(b.name) ? order.get(b.name) : 999;
    return aOrder - bOrder;
  });
}

const vocabularyMap = new Map(
  (vocabulary || []).map((item) => [normalizeWord(item.word), item]),
);
const sections = splitTranscriptSections(transcript);
---

<section class="card transcript-root" data-transcript-root>
  <h2>Transcript</h2>
  <p class="muted" style="font-size:13px;margin-bottom:12px;">
    Tap any word to see it. <strong style="color:var(--primary-blue)">Blue words</strong> are today's vocabulary.
  </p>

  {
    sections.map((section) => {
      const paragraphs = section.content
        .split(/\n{2,}/)
        .map((paragraph) => paragraph.trim())
        .filter(Boolean);

      return (
        <div class="transcript-section">
          <h3 class="transcript-section-title">{section.name}</h3>
          {paragraphs.map((paragraph) => (
            <p class="transcript-paragraph">
              {paragraph.split(/(\s+)/).map((token) => {
                // Whitespace tokens stay as-is
                if (/^\s+$/.test(token)) return token;

                const normalized = normalizeWord(token);
                // Skip very short tokens (punctuation-only, single chars)
                if (normalized.length < 2) return token;

                const vocabItem = vocabularyMap.get(normalized);

                if (vocabItem) {
                  // Vocab word: highlighted + has definition data
                  return (
                    <button
                      type="button"
                      class="transcript-word vocab-token"
                      data-word={token.replace(/[^a-zA-Z'-]/g, "")}
                      data-vocab-word={vocabItem.word}
                      data-vocab-definition={vocabItem.definition}
                      data-vocab-example={vocabItem.example}
                    >
                      {token}
                    </button>
                  );
                }

                // Regular word: tappable but subtle
                return (
                  <button
                    type="button"
                    class="transcript-word"
                    data-word={token.replace(/[^a-zA-Z'-]/g, "")}
                  >
                    {token}
                  </button>
                );
              })}
            </p>
          ))}
        </div>
      );
    })
  }

  <VocabPopup client:load />
</section>

<script is:inline>
  const root = document.querySelector("[data-transcript-root]");
  if (root) {
    root.addEventListener("click", (event) => {
      const target = event.target.closest("[data-word]");
      if (!target) return;

      // Get the clean word
      const word = target.dataset.word;
      if (!word || word.length < 2) return;

      // Check if it's a vocab word (has definition data)
      const isVocabWord = !!target.dataset.vocabWord;

      // Extract sentence context from parent paragraph
      const paragraph = target.closest(".transcript-paragraph");
      let sentence = "";
      if (paragraph) {
        const paraText = paragraph.textContent || "";
        // Split by sentence-ending punctuation
        const sentences = paraText.match(/[^.!?]+[.!?]+/g) || [paraText];
        const wordLower = word.toLowerCase();
        sentence = (
          sentences.find((s) =>
            s.toLowerCase().includes(wordLower)
          ) || paraText
        ).trim();
      }

      window.dispatchEvent(
        new CustomEvent("open-vocab-popup", {
          detail: {
            word: target.dataset.vocabWord || word,
            definition: target.dataset.vocabDefinition || "",
            example: target.dataset.vocabExample || "",
            sentence: sentence,
            isVocabWord: isVocabWord,
          },
        }),
      );
    });
  }
</script>
