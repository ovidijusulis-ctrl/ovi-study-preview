---
const { filename, youtubeUrl, spotifyUrl } = Astro.props;
const base = import.meta.env.BASE_URL;
const audioSrc = filename ? `${base}audio/${filename}` : null;

// Extract Spotify episode ID for embed
// Supports: https://open.spotify.com/episode/XXXXX or spotify:episode:XXXXX
function getSpotifyId(url) {
  if (!url) return null;
  const match = url.match(/episode[:/]([a-zA-Z0-9]+)/);
  return match ? match[1] : null;
}

const spotifyId = getSpotifyId(spotifyUrl);
---

<section class="card">
  <h2>Audio Lesson</h2>

  {spotifyId ? (
    <div class="audio-player">
      <iframe
        class="spotify-embed"
        src={`https://open.spotify.com/embed/episode/${spotifyId}?utm_source=generator&theme=0`}
        width="100%"
        height="152"
        frameborder="0"
        allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
        loading="lazy"
        title="Listen on Spotify"
      ></iframe>
      {youtubeUrl ? (
        <p class="muted" style="margin-top: 4px;">
          Also available on <a href={youtubeUrl} target="_blank" rel="noreferrer">YouTube</a>
        </p>
      ) : null}
    </div>
  ) : youtubeUrl ? (
    <div class="audio-player">
      <p>
        <a class="button button-primary" href={youtubeUrl} target="_blank" rel="noreferrer">
          Listen on YouTube
        </a>
      </p>
    </div>
  ) : audioSrc ? (
    <div class="audio-player">
      <audio controls preload="metadata" src={audioSrc}>
        Your browser does not support the audio element.
      </audio>
      <a class="button button-secondary" href={audioSrc} download>
        Download MP3
      </a>
    </div>
  ) : (
    <p class="muted">Audio is not available for this episode yet.</p>
  )}
</section>
