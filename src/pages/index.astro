---
import fs from "node:fs";
import path from "node:path";
import Layout from "../layouts/Layout.astro";
const base = import.meta.env.BASE_URL;

const episodesDir = path.resolve("data/episodes");
const episodeFiles = fs.existsSync(episodesDir)
  ? fs.readdirSync(episodesDir).filter((file) => file.endsWith(".json"))
  : [];

const episodes = episodeFiles
  .map((file) => {
    const raw = fs.readFileSync(path.join(episodesDir, file), "utf8");
    const parsed = JSON.parse(raw);
    parsed.slug = parsed.slug || parsed.date;
    parsed.id = parsed.id || `episode-${parsed.slug}`;
    return parsed;
  })
  .sort((a, b) => {
    const byDate = String(b.date).localeCompare(String(a.date));
    if (byDate !== 0) return byDate;
    return String(b.slug || "").localeCompare(String(a.slug || ""));
  });
---

<Layout title="Ovi English School | Episode Archive">
  <section class="card archive-toolbar">
    <h1>Episode Archive</h1>
    <div class="archive-sort" role="tablist" aria-label="Sort lessons">
      <button type="button" class="archive-sort-btn is-active" data-sort-btn="newest">Newest</button>
      <button type="button" class="archive-sort-btn" data-sort-btn="popular">Popular</button>
    </div>
  </section>

  <section class="episode-list" id="episodeList">
    {
      episodes.map((episode) => (
        <article
          class="card episode-card"
          data-date={episode.date || ""}
          data-slug={episode.slug || ""}
          data-episode-id={episode.id || ""}
        >
          <h2>
            <a href={`${base}episodes/${episode.slug}`}>{episode.topic}</a>
          </h2>
        </article>
      ))
    }
  </section>
</Layout>

<script is:inline>
  const list = document.getElementById("episodeList");
  const sortButtons = [...document.querySelectorAll("[data-sort-btn]")];
  const SORT_KEY = "episode-archive-sort-mode";
  const RATING_PREFIX = "episode-rating-";

  if (list && sortButtons.length > 0) {
    const cards = [...list.querySelectorAll(".episode-card")].map((el, index) => ({
      el,
      index,
      date: String(el.dataset.date || ""),
      slug: String(el.dataset.slug || ""),
      episodeId: String(el.dataset.episodeId || ""),
    }));

    const getDateValue = (dateString) => {
      const timestamp = Date.parse(dateString);
      return Number.isNaN(timestamp) ? 0 : timestamp;
    };

    const getSavedRating = (episodeId) => {
      if (!episodeId) return 0;
      try {
        const raw = localStorage.getItem(`${RATING_PREFIX}${episodeId}`);
        if (!raw) return 0;
        const parsed = JSON.parse(raw);
        const avg = Number(parsed?.average || 0);
        return Number.isFinite(avg) ? avg : 0;
      } catch (_err) {
        return 0;
      }
    };

    const popularityScore = (card) => {
      const rating = getSavedRating(card.episodeId); // 0..5
      const ageMs = Math.max(0, Date.now() - getDateValue(card.date));
      const ageDays = ageMs / (1000 * 60 * 60 * 24);
      const freshness = Math.max(0, 30 - ageDays) / 6; // up to +5
      return rating * 20 + freshness;
    };

    const comparators = {
      newest: (a, b) => {
        const byDate = getDateValue(b.date) - getDateValue(a.date);
        if (byDate !== 0) return byDate;
        const bySlug = b.slug.localeCompare(a.slug);
        if (bySlug !== 0) return bySlug;
        return a.index - b.index;
      },
      popular: (a, b) => {
        const byScore = popularityScore(b) - popularityScore(a);
        if (byScore !== 0) return byScore;
        return comparators.newest(a, b);
      },
    };

    const setActiveButton = (mode) => {
      sortButtons.forEach((btn) => {
        const active = btn.dataset.sortBtn === mode;
        btn.classList.toggle("is-active", active);
        btn.setAttribute("aria-selected", active ? "true" : "false");
      });
    };

    const render = (mode) => {
      const comparator = comparators[mode] || comparators.newest;
      cards
        .slice()
        .sort(comparator)
        .forEach((card) => list.appendChild(card.el));
      setActiveButton(mode);
      try {
        localStorage.setItem(SORT_KEY, mode);
      } catch (_err) {
        // ignore localStorage failures
      }
    };

    sortButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const mode = btn.dataset.sortBtn || "newest";
        render(mode);
      });
    });

    window.addEventListener("episode-rating-updated", () => {
      const active = sortButtons.find((btn) => btn.classList.contains("is-active"));
      const mode = active?.dataset.sortBtn || "newest";
      if (mode === "popular") render("popular");
    });

    let initialMode = "newest";
    try {
      const stored = localStorage.getItem(SORT_KEY);
      if (stored === "newest" || stored === "popular") initialMode = stored;
    } catch (_err) {
      // ignore localStorage failures
    }
    render(initialMode);
  }
</script>
