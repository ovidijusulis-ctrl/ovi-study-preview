---
import fs from "node:fs";
import path from "node:path";
import Layout from "../layouts/Layout.astro";
const base = import.meta.env.BASE_URL;

const episodesDir = path.resolve("data/episodes");
const episodeFiles = fs.existsSync(episodesDir)
  ? fs.readdirSync(episodesDir).filter((file) => file.endsWith(".json"))
  : [];

const episodes = episodeFiles
  .map((file) => {
    const raw = fs.readFileSync(path.join(episodesDir, file), "utf8");
    return JSON.parse(raw);
  })
  .sort((a, b) => String(b.date).localeCompare(String(a.date)));

function formatDate(dateString) {
  const date = new Date(`${dateString}T00:00:00`);
  return date.toLocaleDateString("en-US", {
    weekday: "long",
    month: "long",
    day: "numeric",
    year: "numeric",
  });
}
---

<Layout title="Ovi English School | Episode Archive">
  <section class="card">
    <h1>Episode Archive</h1>
    <p>
      Learn English with real stories. Choose an episode to open the full lesson with audio,
      transcript, flashcards, and quiz.
    </p>
  </section>

  <section class="episode-list">
    {
      episodes.map((episode) => (
        <article class="card episode-card">
          <p class="muted">{formatDate(episode.date)}</p>
          <h2>
            <a href={`${base}episodes/${episode.date}`}>{episode.topic}</a>
          </h2>
          <div class="episode-meta">
            <span class="badge">
              {episode.level === "intermediate" ? "Intermediate B1-B2" : "Beginner A1-A2"}
            </span>
            <span class="muted">{(episode.vocabulary || []).length} words</span>
          </div>
          <p class="episode-summary">{episode.summary}</p>
          <a class="button button-primary" href={`${base}episodes/${episode.date}`}>
            Open Lesson
          </a>
        </article>
      ))
    }
  </section>
</Layout>
