---
import Layout from "../../layouts/Layout.astro";
import AudioPlayer from "../../components/AudioPlayer.astro";
import Transcript from "../../components/Transcript.astro";
import FlashcardDeck from "../../components/FlashcardDeck.jsx";
import FlashcardVocabTest from "../../components/FlashcardVocabTest.jsx";
import FeedbackWidget from "../../components/FeedbackWidget.jsx";

export async function getStaticPaths() {
  const fs = await import("node:fs");
  const path = await import("node:path");
  const episodesDir = path.resolve("data/episodes");
  const episodeFiles = fs.existsSync(episodesDir)
    ? fs.readdirSync(episodesDir).filter((file) => file.endsWith(".json"))
    : [];
  const episodes = episodeFiles.map((file) => {
    const raw = fs.readFileSync(path.join(episodesDir, file), "utf8");
    const parsed = JSON.parse(raw);
    parsed.slug = parsed.slug || parsed.date;
    return parsed;
  });

  return episodes.map((episode) => ({
    params: { date: episode.slug },
    props: { episode },
  }));
}

const { episode } = Astro.props;
const pageTitle = `${episode.topic} | Ovi English School`;
const base = import.meta.env.BASE_URL;
const pdfUrl = episode?.urls?.pdf || "";
const headerSummarySource = String(
  episode.summaryShort
    || episode.summary
    || episode.sections?.newsStory
    || ""
).replace(/\s+/g, " ").trim();

const shortSummary = headerSummarySource.length > 180
  ? `${headerSummarySource.slice(0, 177).trim()}...`
  : headerSummarySource;
const ldJson = {
  "@context": "https://schema.org/",
  "@type": "PodcastEpisode",
  name: episode.topic,
  datePublished: episode.date,
  educationalLevel:
    episode.level === "intermediate"
      ? "Intermediate (CEFR B1-B2)"
      : "Beginner (CEFR A1-A2)",
  learningResourceType: ["Transcript", "Quiz", "Flashcard", "PodcastEpisode"],
  about: {
    "@type": "Thing",
    name: episode.topic,
  },
  isPartOf: {
    "@type": "PodcastSeries",
    name: "Ovi English School",
    url: "https://ovidijusulis-ctrl.github.io/ovi-study-site",
  },
  author: {
    "@type": "Organization",
    name: "Ovi English School",
    url: "https://ovidijusulis-ctrl.github.io/ovi-study-site",
  },
  url: `https://ovidijusulis-ctrl.github.io/ovi-study-site/episodes/${episode.slug || episode.date}`,
};
---

<Layout title={pageTitle} description={episode.summaryShort || episode.summary}>
  <script slot="head" type="application/ld+json" set:html={JSON.stringify(ldJson)}></script>

  <article data-episode-id={episode.id || `episode-${episode.slug || episode.date || ""}`}>
    <section class="card episode-header">
      <a class="back-link" href={base}>Back to Archive</a>
      <h1>{episode.topic}</h1>
      {episode?.quality?.qualityPass && (
        <p class="muted" style="margin: 0 0 6px; font-size: 12px;">Quality checked lesson</p>
      )}
      <p>{shortSummary || "Short story summary not available."}</p>
    </section>

    <AudioPlayer
      filename={episode.audio?.filename}
      youtubeUrl={episode.urls?.youtube}
      spotifyUrl={episode.urls?.spotify}
    />
    <Transcript
      transcript={episode.transcript}
      paragraphQuestions={episode.paragraphQuestions || []}
      vocabulary={episode.vocabulary || []}
    />
    <FlashcardDeck client:load episodeId={episode.id} />
    <FlashcardVocabTest client:load episodeId={episode.id} />

    <section class="card listen-again" id="listen-again">
      <h2>Listen Again</h2>
      <p>
        You read the story and practiced the key words. Now listen one more
        time â€” you will understand much more!
      </p>
      {
        episode.urls?.youtube ? (
          <p>
            <a class="button button-primary" href={episode.urls.youtube} target="_blank" rel="noreferrer">
              Listen again on YouTube
            </a>
          </p>
        ) : episode.audio?.filename ? (
          <audio
            controls
            preload="metadata"
            src={`${base}audio/${episode.audio.filename}`}
            style="width: 100%;"
          ></audio>
        ) : null
      }
      <p class="muted" style="margin-top: 8px;">
        Re-listening after studying helps you remember new words better.
      </p>
    </section>

    <FeedbackWidget client:load episodeId={episode.id} />

    <section class="card">
      <h2>Resources</h2>
      <ul class="resource-list">
        {
          episode?.urls?.youtube ? (
            <li>
              <a href={episode.urls.youtube} target="_blank" rel="noreferrer">
                Listen on YouTube
              </a>
            </li>
          ) : (
            <li class="muted">YouTube link not available</li>
          )
        }
        {
          pdfUrl ? (
            <li>
              <a href={pdfUrl} target="_blank" rel="noreferrer">
                Download PDF Guide
              </a>
            </li>
          ) : null
        }
        <li>
          <a href={`${base}feed.xml`}>Subscribe (RSS)</a>
        </li>
        <li>
          <a
            href={`https://ovidijusulis-ctrl.github.io/ovi-study-site/episodes/${episode.slug || episode.date}`}
            onclick="if(navigator.share){event.preventDefault();navigator.share({title:document.title,url:window.location.href})}"
          >
            Share this lesson
          </a>
        </li>
        <li>
          <a href="mailto:English.ovi@gmail.com">Contact us (English.ovi@gmail.com)</a>
        </li>
      </ul>
    </section>
  </article>

  <script
    is:inline
    define:vars={{ episodeId: episode.id || `episode-${episode.slug || episode.date || ""}` }}
  >
    (() => {
      if (typeof window === "undefined" || !episodeId) return;

      const PREFIX = "episode-behavior-";
      const KEY = `${PREFIX}${episodeId}`;
      const VALID_METRICS = new Set([
        "opens",
        "scrollDepthMax",
        "completions",
        "flashcardAdds",
        "vocabTestStarts",
        "vocabTestCompletions",
        "readingModeStarts",
        "readingAutoStarts",
        "listeningStarts",
        "activeSeconds",
      ]);

      const defaults = () => ({
        opens: 0,
        scrollDepthMax: 0,
        completions: 0,
        flashcardAdds: 0,
        vocabTestStarts: 0,
        vocabTestCompletions: 0,
        readingModeStarts: 0,
        readingAutoStarts: 0,
        listeningStarts: 0,
        activeSeconds: 0,
        updatedAt: Date.now(),
        version: 1,
      });

      const readState = () => {
        try {
          const raw = localStorage.getItem(KEY);
          if (!raw) return defaults();
          const parsed = JSON.parse(raw);
          if (!parsed || typeof parsed !== "object") return defaults();
          return { ...defaults(), ...parsed };
        } catch (_err) {
          return defaults();
        }
      };

      let stateCache = readState();

      const writeState = (next) => {
        const payload = { ...defaults(), ...next, updatedAt: Date.now(), version: 1 };
        stateCache = payload;
        try {
          localStorage.setItem(KEY, JSON.stringify(payload));
        } catch (_err) {
          // ignore localStorage failures
        }
        window.dispatchEvent(
          new CustomEvent("episode-behavior-updated", {
            detail: { episodeId, state: payload },
          }),
        );
      };

      const bump = (metric, amount = 1) => {
        if (!VALID_METRICS.has(metric)) return;
        const current = Number(stateCache[metric] || 0);
        const next = Math.max(0, current + Number(amount || 0));
        if (next === current) return;
        writeState({ ...stateCache, [metric]: next });
      };

      const setMax = (metric, value) => {
        if (!VALID_METRICS.has(metric)) return;
        const current = Number(stateCache[metric] || 0);
        const next = Math.max(current, Number(value || 0));
        if (next === current) return;
        writeState({ ...stateCache, [metric]: next });
      };

      bump("opens", 1);

      let completedThisVisit = false;
      let listeningLogged = false;
      let visibleStartedAt = document.visibilityState === "visible" ? Date.now() : 0;
      let activeMsBuffer = 0;

      const flushActiveSeconds = () => {
        if (visibleStartedAt > 0) {
          activeMsBuffer += Date.now() - visibleStartedAt;
          visibleStartedAt = Date.now();
        }
        const wholeSeconds = Math.floor(activeMsBuffer / 1000);
        if (wholeSeconds > 0) {
          activeMsBuffer -= wholeSeconds * 1000;
          bump("activeSeconds", wholeSeconds);
        }
      };

      const computeScrollDepth = () => {
        const doc = document.documentElement;
        const scrollable = Math.max(0, (doc?.scrollHeight || 0) - window.innerHeight);
        if (scrollable <= 0) return 100;
        return Math.round((window.scrollY / scrollable) * 100);
      };

      let scrollTicking = false;
      const onScroll = () => {
        if (scrollTicking) return;
        scrollTicking = true;
        window.requestAnimationFrame(() => {
          scrollTicking = false;
          const depth = Math.max(0, Math.min(100, computeScrollDepth()));
          setMax("scrollDepthMax", depth);
          if (!completedThisVisit && depth >= 80) {
            completedThisVisit = true;
            bump("completions", 1);
          }
        });
      };

      const onVisibilityChange = () => {
        if (document.visibilityState === "hidden") {
          if (visibleStartedAt > 0) {
            activeMsBuffer += Date.now() - visibleStartedAt;
            visibleStartedAt = 0;
          }
          flushActiveSeconds();
          return;
        }
        visibleStartedAt = Date.now();
      };

      const onPageHide = () => {
        if (visibleStartedAt > 0) {
          activeMsBuffer += Date.now() - visibleStartedAt;
          visibleStartedAt = 0;
        }
        flushActiveSeconds();
      };

      const nativeAudio = document.querySelector(".audio-player audio");
      const onNativePlay = () => {
        if (listeningLogged) return;
        listeningLogged = true;
        bump("listeningStarts", 1);
      };
      nativeAudio?.addEventListener("play", onNativePlay);

      const platformLinks = [...document.querySelectorAll(".audio-player a[href]")];
      const onPlatformClick = (event) => {
        const href = String(event.currentTarget?.getAttribute?.("href") || "").toLowerCase();
        if (!href) return;
        if (!href.includes("youtube.com") && !href.includes("spotify.com")) return;
        bump("listeningStarts", 1);
      };
      platformLinks.forEach((link) => link.addEventListener("click", onPlatformClick));

      const onBehaviorEvent = (event) => {
        const metric = String(event?.detail?.metric || "");
        const amount = Number(event?.detail?.amount || 1);
        if (!VALID_METRICS.has(metric)) return;
        if (!Number.isFinite(amount) || amount <= 0) return;
        bump(metric, amount);
      };
      window.addEventListener("episode-behavior", onBehaviorEvent);

      window.addEventListener("scroll", onScroll, { passive: true });
      document.addEventListener("visibilitychange", onVisibilityChange);
      window.addEventListener("pagehide", onPageHide);
    })();
  </script>
</Layout>
